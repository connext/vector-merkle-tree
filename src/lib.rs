use std::cell::RefCell;

use faster_hex::hex_decode;
use format::hex_encode;
use wasm_bindgen::prelude::*;

thread_local! {
    // TODO: (Performance)
    // This scratch is way too big. If using depth-first traversal
    // only 2 * log2(n) values would be needed at any time, instead of
    // the n values we are using now. (Justifies just using the stack
    // and recursing, even)
    static SCRATCH: RefCell<Vec<Bytes32>> = RefCell::new(Vec::new());
}

type Bytes32 = [u8; 32];

mod error;
mod format;
mod hash;

#[cfg(test)]
mod test_utils;

pub use error::Error;

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub(crate) struct Node {
    hash: Bytes32,
    transfer_id: Bytes32,
}

#[wasm_bindgen]
#[derive(Debug, Clone)]
pub struct Tree {
    leaves: Vec<Node>,
}

#[wasm_bindgen]
impl Tree {
    #[wasm_bindgen(constructor)]
    pub fn new() -> Self {
        Self { leaves: Vec::new() }
    }

    pub fn insert_hex_js(&mut self, core_transfer_state: &str) -> Result<(), JsValue> {
        self.insert_hex(core_transfer_state)
            .map_err(|e| JsValue::from_str(&format!("{}", e)))
    }

    pub fn delete_id_js(&mut self, transfer_id: &str) -> Result<(), JsValue> {
        if transfer_id.len() != 66 || &transfer_id[..2] != "0x" {
            return Err(JsValue::from_str("Invalid transfer id"));
        }
        let mut bytes = Bytes32::default();
        hex_decode(transfer_id.as_bytes(), &mut bytes)
            .map_err(|_| JsValue::from_str("Invalid transfer id"))?;

        self.delete_id(bytes)
            .map_err(|_| JsValue::from_str("Transfer id not found"))
    }

    pub fn root_js(&self) -> JsValue {
        let root = self.root();
        let s = "0x".to_owned() + &hex_encode(root);
        JsValue::from_str(&s)
    }
}

impl Tree {
    fn insert_node(&mut self, node: Node) -> Result<(), Error> {
        let index = match self
            .leaves
            .binary_search_by_key(&&node.transfer_id, |n| &n.transfer_id)
        {
            // This structure cannot handle a duplicate transfer ID because there
            // would not be one canonical ordering.
            Ok(_) => return Err(Error::DuplicateTransferID),
            Err(i) => i,
        };
        self.leaves.insert(index, node);
        Ok(())
    }

    /// Insert a leaf with the given transfer state.
    pub fn insert_hex(&mut self, core_transfer_state: &str) -> Result<(), Error> {
        let node = format::hex_to_node(core_transfer_state)?;
        self.insert_node(node)
    }

    /// Remove the leaf corresponding to the transfer with a given id.
    pub fn delete_id(&mut self, transfer_id: Bytes32) -> Result<(), ()> {
        match self
            .leaves
            .binary_search_by_key(&&transfer_id, |n| &n.transfer_id)
        {
            Ok(i) => {
                self.leaves.remove(i);
                Ok(())
            }
            Err(_) => Err(()),
        }
    }

    /// It is intentional that this method is separate from insert/delete.
    /// One expected use-case is to insert, calculate a new hash, propose an
    /// update, fail, and finally need to roll back. To roll back the best thing to
    /// do is just to delete without calculating the root.
    pub fn root(&self) -> Bytes32 {
        if self.leaves.len() == 0 {
            return Default::default();
        }

        SCRATCH.with(|scratch| {
            let mut scratch = scratch.borrow_mut();

            while scratch.len() < self.leaves.len() {
                scratch.push(Default::default())
            }

            let mut scratch = &mut scratch[..self.leaves.len()];

            for i in 0..scratch.len() {
                scratch[i] = self.leaves[i].hash;
            }

            while scratch.len() > 1 {
                let mut write = 0;
                let mut read = 0;
                while read + 1 < scratch.len() {
                    let a = scratch[read];
                    let b = scratch[read + 1];
                    read += 2;
                    scratch[write] = hash::combine(&a, &b);
                    write += 1;
                }
                if read < scratch.len() {
                    scratch[write] = scratch[read];
                    write += 1;
                }

                scratch = &mut scratch[0..write];
            }

            scratch[0]
        })
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    use format::hex_to_node;
    use std::time::Instant;
    use test_utils::*;

    #[test]
    #[ignore]
    fn speed() {
        let start = Instant::now();
        let mut tree = Tree::new();
        let mut break_optimizer = [0u8; 32];
        for i in 0u32..2000 {
            // Start with a transfer that was generated by tests
            let mut data = "0x000000000000000000000000ccc00000000000000000000000000000000000000de5846e2e915d4bad7b8fbb3822b932367a24691960d57cd983257037553411000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000".to_owned();
            // Give it a random transfer id
            for c in 66..130 {
                let h = (rand((i, c)) % 10) + 48;
                // Safe because h is within range 48->57 (inclusive)
                unsafe { data.as_bytes_mut()[c] = h as u8 };
            }
            // Insert and calculate new root
            tree.insert_hex(&data)
                .expect("Duplicate transfer ids unlikely");
            let root = tree.root();

            // Derive data to ensure the loop isn't optimized away
            let index = (i % 32) as usize;
            let opt = &mut break_optimizer[index];
            *opt = opt.wrapping_add(root[index]);
        }

        // Print the time and info to ensure that the loop wasn't optimized away.
        println!("{:?}", Instant::now() - start);
        println!("{}", hex_encode(break_optimizer));
    }

    // Ensures that the result is the same as before.
    #[test]
    fn backward_compatible() {
        let encoded_transfers = [
            "0x000000000000000000000000ccc000000000000000000000000000000000000005549d00942c85d5004b75e5cd02acce4f330a7be6a8f6c5a1fabbf5b4cdd828000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000007ace82c0553bb5ca2aa65a36575e03c7f828862331d1c46dfb6670e4c4df42e000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000009f144821123db1bfc74c7ee6cbc8d165f5811c1e3e7ba7fe712c94fd8269c48000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000000dfe90e4da4d7751ed146dda5ddab63b79e9b289a1e5a8df3043c6f310d048e4000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000003299fc09866576090f3aac16947ac1d5609643de11bac44e1078f46c1d3e2d88000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000046e175ab10c6eda80a359597463ddab7964cde65aab637841ca4dae99cc70a03000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000004c58e396ee023abc1527ed314f5a8d5f400a3368db05fe94912052739bcc76c7000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000005dcb4070cac9caf98dc6d52e8c894d66ca56a604fddc5997e12b68ef3d157601000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000601d0c7b09a5497afb3b40af416db9849b5aedccc28db446e5a4c820febe9f1e000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000801577b9f75b982587cf3990dfc64f470737e8b541ea584d1a5f5256b4a93142000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000008aabe587d75461d49fa307817b2d8838a491f2c05651df8524ccd92bf452872d000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009137e2f6cb80b96f774f8ed2373994541f66a8689f447087e69206427da05515000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009552d4fead25e7e1e3b5ade019dcd6af4512f88872c6969b4d46022dbcc78284000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009f85649dfee68d6fa25ec750fc8a0acb8249a35f2ec6fd9636d1d1ef03eaf2b3000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000a3dcf8776fa5875dc396ab38acfe7281fa9ecf436f5b2726842c4b2d5fbcadc4000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000a57a4368df0abc7d96913bc3f17979db404218797cc821ccaf290ee1fe585cbf000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000aa29aab59197f98b58737c083159bf03c601671341d9022681ba17c4db88fb32000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000ac5dc7ee2f3ee59658fdf9566663329ac102e66d19d629b5c3ba9af21aec9ffe000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000dcd3135bc272cec12f4247fa064251e200c53c9ed6be8e644f8a1ba650c1a676000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000e3efadc64aeb650945b72bac219c1633a632dc7d77925359b7e546cb88fa7f43000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
        ];

        let results = [
            "f904cda0a4dfdbe1e6e2d48a131810dc8d62f2af02f04a940f792fea44b7bdb2",
            "6ac2b38459206338b7da7f5c85578e5a7ca8c02d5e541b17a0a4769b792c76ab",
            "f0636436ea54a4bb432238f704252cc2f73d45c801ae7aecd10b105d32bc7827",
            "d3691afa76c335f1e8016a9efad192a7c4d3d9931958b07dc1482e2d2fd191c8",
            "6cf598cc2d7be3ade6ac4182661a3de96f4242537d9a9573847ecc1ea9363eb4",
            "04df001aad685cd1a6538e28a62d12d5e5af759a70ffda3c053f8a6aa7f997fd",
            "5e299452c6ecfe23f19f89d3eb9348fd271bdaa1292fb92941a488a1dfa8120e",
            "94ffc901bfe33c04a3877277fc443ef0787e80734fa6d48a5261175d6bf2b4e5",
            "2745ecce64da66937b26ecc9a4927709ed72f2b0c59c0137519f3d9abe277e39",
            "17aaf4493bfb1371236dff66f52f98aed31a8fe2a1c03a8b3b6cb97a64038fff",
            "e874c0d3af22c5257ee85ea6f9d40e602d25a8c214bf162a1f583762ec753361",
            "02213f6528f5eac988bdb317c9e3a784dccb15aacf956ee9470c3b6ec4671dfa",
            "26f15e157f00bdfd29419a62937b9a25c1cd3fc31c3f6dad593cfbbde66848ef",
            "979523bc8738f0ec7e0327d17a6ba6656eb6588b386484b361ed4b60296190dc",
            "b2adb581828bf42f51d21e95ee59434ec28a3d3928c9abe64a0e2a3d4b88080d",
            "e1152c6663c84a3278c5d410fe5776c7fe34731ffda758e6d1e15e27318192a7",
            "5bcc5762c1a81229e6c1710e9de07e96a58d49a4f76c6477cfb60bd1960b50e8",
            "738be9cf6a53c8d1333846a8809e674f13065d2ca36ed27140cdef6d03f89977",
            "2b99cf90fb5f7997f0a1adda10cc4775f2140375aab67c3068417938ba375962",
            "b44b5117f45015f0bb720ded7831fff6ad9c35ac5d534f5237fed43c873afa76",
        ];

        let mut tree = Tree::new();
        for i in 0..encoded_transfers.len() {
            tree.insert_hex(encoded_transfers[i])
                .expect("Transfer id should be unique");
            let root = hex_encode(tree.root());
            assert_eq!(root, results[i]);
        }
    }

    /// Verify that running deletes doesn't affect the result as compared
    /// to having created the tree from scratch
    #[test]
    fn set_unique() {
        let mut encoded_transfers = vec![
            "0x000000000000000000000000ccc000000000000000000000000000000000000005549d00942c85d5004b75e5cd02acce4f330a7be6a8f6c5a1fabbf5b4cdd828000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000007ace82c0553bb5ca2aa65a36575e03c7f828862331d1c46dfb6670e4c4df42e000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000009f144821123db1bfc74c7ee6cbc8d165f5811c1e3e7ba7fe712c94fd8269c48000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000000dfe90e4da4d7751ed146dda5ddab63b79e9b289a1e5a8df3043c6f310d048e4000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000003299fc09866576090f3aac16947ac1d5609643de11bac44e1078f46c1d3e2d88000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc000000000000000000000000000000000000046e175ab10c6eda80a359597463ddab7964cde65aab637841ca4dae99cc70a03000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000004c58e396ee023abc1527ed314f5a8d5f400a3368db05fe94912052739bcc76c7000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000005dcb4070cac9caf98dc6d52e8c894d66ca56a604fddc5997e12b68ef3d157601000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000601d0c7b09a5497afb3b40af416db9849b5aedccc28db446e5a4c820febe9f1e000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000801577b9f75b982587cf3990dfc64f470737e8b541ea584d1a5f5256b4a93142000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000008aabe587d75461d49fa307817b2d8838a491f2c05651df8524ccd92bf452872d000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009137e2f6cb80b96f774f8ed2373994541f66a8689f447087e69206427da05515000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009552d4fead25e7e1e3b5ade019dcd6af4512f88872c6969b4d46022dbcc78284000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc00000000000000000000000000000000000009f85649dfee68d6fa25ec750fc8a0acb8249a35f2ec6fd9636d1d1ef03eaf2b3000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000a3dcf8776fa5875dc396ab38acfe7281fa9ecf436f5b2726842c4b2d5fbcadc4000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000a57a4368df0abc7d96913bc3f17979db404218797cc821ccaf290ee1fe585cbf000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000aa29aab59197f98b58737c083159bf03c601671341d9022681ba17c4db88fb32000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000ac5dc7ee2f3ee59658fdf9566663329ac102e66d19d629b5c3ba9af21aec9ffe000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000dcd3135bc272cec12f4247fa064251e200c53c9ed6be8e644f8a1ba650c1a676000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
            "0x000000000000000000000000ccc0000000000000000000000000000000000000e3efadc64aeb650945b72bac219c1633a632dc7d77925359b7e546cb88fa7f43000000000000000000000000def0000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa00000000000000000000000000000000000000000000000000000000000000bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001abcdef0000000000000000000000000000000000000000000000000000000000",
        ];

        let mut tree = Tree::new();
        for transfer in encoded_transfers.iter() {
            tree.insert_hex(transfer).unwrap();
        }

        while encoded_transfers.len() > 0 {
            let idx = rand(encoded_transfers.len()) % (encoded_transfers.len() as u64);
            // Using swap_remove further verifies this is set-unique
            // because the order added will be different.
            let removed = encoded_transfers.swap_remove(idx as usize);
            let transfer_id = hex_to_node(removed).unwrap().transfer_id;
            assert!(tree.delete_id(transfer_id).is_ok());
            assert!(tree.delete_id(transfer_id).is_err());

            let mut copy = Tree::new();
            for transfer in encoded_transfers.iter() {
                copy.insert_hex(transfer).unwrap();
            }

            assert_eq!(copy.root(), tree.root());
        }
    }

    #[test]
    fn empty_set() {
        let root = Tree::new().root();
        assert_eq!(
            hex_encode(root),
            "0000000000000000000000000000000000000000000000000000000000000000"
        )
    }
}
